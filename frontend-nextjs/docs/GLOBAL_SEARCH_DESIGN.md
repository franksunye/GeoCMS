# 全局搜索与 AI Agent 交互设计方案

在 AI Agent 时代，全局搜索已经从简单的“关键词匹配”演变为 **“自然语言意图接口 (NLI)”**。本方案旨在将传统的全局检索能力与 AI 的推理、执行能力深度融合，打造一个 AI-Native 的全能入口。

---

## 一、 传统搜索 vs. AI-Native 全局交互

| 维度 | 传统全局搜索 (Traditional) | AI-Native 全局交互 (Agentic) |
| :--- | :--- | :--- |
| **核心逻辑** | 过滤与匹配 (Filter & Match) | 理解与推理 (Perception & Reasoning) |
| **交互媒介** | 关键词、标签选择器 | 自然语言 (NL)、多轮对话 |
| **结果形式** | 静态列表、超链接 | 直接答案、摘要总结、执行动作 |
| **上下文** | 无状态 (Stateless)，每次搜索独立 | 有记忆 (Memory)，理解用户当前所处页面与意图 |
| **能力边界** | 仅限于“找到” (Find) | 扩展到“分析”与“执行” (Analyze & Act) |

---

## 二、 核心设计理念

1.  **从“搜索”到“提问”**：用户不再搜索“张三 通话”，而是提问“总结一下昨天张三的所有通话表现”。
2.  **从“结果”到“答案”**：利用 RAG (检索增强生成)，直接在搜索框下方给出合成后的答案，而不是让用户自己点开 10 个通话。
3.  **从“查找”到“行动” (Search-to-Action)**：搜索框也是指令框。输入“导出上周的高分通话到 Excel”应能触发具体任务。
4.  **双模态入口 (Hybrid Interface)**：保留 `⌘K` 的快速跳转与关键词搜索习惯，同时支持点击一键切换到“AI 深度模式”。

---

## 三、 功能分类与数据源

### 3.1 意图识别分类 (Intent Classification)
Agent 会根据输入将搜索划分为三个等级：
*   **L1 快速导航/检索**：搜索坐席姓名、通话 ID、菜单路径。
*   **L2 语义洞察**：搜索“免费试用”、“客户抱怨”，匹配内容语义而非字面。
*   **L3 复杂指令/分析**：诸如“分析本周坐席平均得分趋势”或“找出转化率最高的 5 个话术”。

### 3.2 动态上下文增强 (Contextual Awareness)
AI Agent 会感知用户当前的页面环境：
*   如果用户在“通话详情页”按下 `⌘K`，搜索范围自动优先权重给“当前通话的转录文本”和“关联案例”。

---

## 四、 UI/UX 体验设计

### 4.1 全能入口 (The Universal Entry)
```text
┌─────────────────────────────────────────────────────────────┐
│ ✦ Ask AI Agent ...                               [⌘ K 唤起]   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  🔍  [ 总结昨天高分通话中表现最好的 3 个共情案例        ]      │
│                                                              │
│  ✨  AI 实时推理中...                                         │
│  ┌──────────────────────────────────────────────────┐       │
│  │ 💡 AI 摘要: 昨天共有 42 条高分通话。表现最好的共情案例：     │
│  │ 1. 通话 #487...: 坐席在客户质疑时通过主动降价... (查看详情) │
│  │ 2. 通话 #492...: ...                                     │
│  └──────────────────────────────────────────────────┘       │
│                                                              │
│  � 推荐操作:                                                 │
│  [ 生成周报 ] [ 查看对应录音 ] [ 转发给相关坐席 ]               │
│                                                              │
│  📋 基础检索结果:                                             │
│  • 🎧 通话: 487460416... (匹配 "共情")                       │
│  • 👥 坐席: 张三 (匹配语义)                                   │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 交互特性
*   **指令自动建议 (Autocomplete)**：当输入 `/` 或特定触发词时，提示 AI 指令（如 `/analyze`, `/export`, `/summarize`）。
*   **流式输出 (Streaming)**：AI 答案实时打字机吐出，保持交互的活跃感。
*   **多轮追问**：搜索结果下方提供“继续提问”按钮，进入侧边栏对话模式。

---

## 五、 技术架构演进

### Phase 1: 语义与全文混合搜索 (FTS5 + Hybrid)
*   **核心**：使用 SQLite FTS5 解决“看得见”的匹配，引入 Embedding 相似度解决“搜得深”的需求。
*   **目标**：提升查找的准确度。

### Phase 2: RAG 增强型搜索 (Search with Answer)
*   **核心**：将搜索结果（Context）喂给 LLM，生成直接答案。
*   **目标**：消除用户的点击成本，即搜即得。

### Phase 3: Agent 任务分发 (Actionable Search)
*   **核心**：引入 Tool-calling 设计，使搜索框能够根据 NL 意图调用系统现有的 API（如导出、评分、预警设置）。
*   **目标**：使搜索框成为系统的“操作系统级指令行”。

---

## 七、 技术可行性与路径选择

基于当前架构，该方案具备高度可行性，核心组件均已就位：

### 7.1 技术栈匹配度
*   **前端 (FE)**：已具备 `Radix UI`（弹窗组件）和 `Framer Motion`（动画效果）。完全支持构建高性能的 **Command Palette**。
*   **大脑 (AI)**：现有的 `src/lib/ai-service.ts` 已深度集成 **DeepSeek API**，仅需扩展 `search-context` 处理器即可支持 RAG 和意图分发。
*   **数据 (DB)**：
    *   **快速路径 (MVP)**：继续使用 SQLite，通过底层 `SQL` 手动创建 `FTS5` 全文索引表进行字面搜索。
    *   **AI-Native 路径 (推荐)**：迁移至 **PostgreSQL (Supabase)**，利用 `pgvector` 存储通话片段的向量（Embedding），实现真正的“按语义搜索”。

### 7.2 关键实现步骤
1.  **意图路由器 (Intent Router)**：在后端增加逻辑，判断用户输入是关键词搜索（调用 SQL）还是分析/执行需求（调用 LLM）。
2.  **RAG 管道**：将匹配到的通话转录片段作为 Context 注入 Prompt，生成即时摘要。
3.  **UI 降级处理**：搜索时先利用 SQL 毫秒级返回列表结果（满足 L1），随后流式呈现 AI 的深度分析（满足 L2/L3），消除等待感。

---

## 八、 待研判问题 (Updated)

1.  **AI 的侵入性**：用户是否需要随时切换 AI/传统模式的开关？
2.  **响应速度平衡**：AI 推理存在 1-3s 延迟，如何通过“先列表后总结”的异步 UI 策略平滑渡过？
3.  **安全边界**：通过搜索框触发“批量删除”等敏感指令时的二次确认工作流设计。

